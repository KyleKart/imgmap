<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Mapper</title>
<style>
  body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f4f4f4; text-align:center; padding:16px; }
  #canvasContainer {
    border:1px solid #333;
    overflow: auto;
    display: inline-block;
    max-width: 90vw;
    max-height: 80vh;
    background:white;
  }
  canvas { cursor:crosshair; image-rendering:pixelated; display:block; }
  #controls { margin-bottom:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; align-items:center; }
  button { padding:6px 10px; }
  #controls > div {
  display: flex;
  flex-direction: column;
}
</style>
</head>
<body>
<h2>Image Mapper</h2>
<h4>Map tiles from one image onto another!</h4>

<div id="controls">
  <div>
    <label>Base Image: <input type="file" id="baseLoader" accept="image/*"></label><br>
    <label>Tile Pack: <input type="file" id="packLoader" accept="image/*"></label>
  </div>

  <div>
    <label>Tile Size: <input type="number" id="tileSize" value="16" min="1" style="width:72px"></label>
    <label>View Scale: <input type="number" id="scale" value="2" min="1" style="width:72px"></label>
  </div>

  <button id="applyBtn">Apply Tile Pack</button>
</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let baseImg = new Image();
let packImg = new Image();
let tileSize = Number(document.getElementById('tileSize').value);
let scale = Number(document.getElementById('scale').value);

document.getElementById('tileSize').addEventListener('change', () => { tileSize = Number(document.getElementById('tileSize').value); });
document.getElementById('scale').addEventListener('change', () => { scale = Number(document.getElementById('scale').value); redrawBase(); });

document.getElementById('baseLoader').addEventListener('change', (e) => loadImage(e, baseImg, true));
document.getElementById('packLoader').addEventListener('change', (e) => loadImage(e, packImg));
document.getElementById('applyBtn').addEventListener('click', () => {
  if (!baseImg.src || !packImg.src) { alert('Load both images!'); return; }
  applyTexturePack();
});

function loadImage(e, imgObj, redraw=false) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    imgObj.src = ev.target.result;
    imgObj.onload = () => { if (redraw) redrawBase(); };
  };
  reader.readAsDataURL(file);
}

function redrawBase() {
  if (!baseImg.src) return;
  canvas.width = baseImg.width * scale;
  canvas.height = baseImg.height * scale;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(baseImg, 0, 0, baseImg.width * scale, baseImg.height * scale);
}

function getTileData(img, x, y, size) {
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = size; tempCanvas.height = size;
  const tempCtx = tempCanvas.getContext('2d');
  tempCtx.drawImage(img, x, y, size, size, 0, 0, size, size);
  return tempCtx.getImageData(0, 0, size, size).data.join(',');
}

function applyTexturePack() {
  const baseTilesX = Math.ceil(baseImg.width / tileSize);
  const baseTilesY = Math.ceil(baseImg.height / tileSize);
  const packTilesX = Math.ceil(packImg.width / tileSize);
  const packTilesY = Math.ceil(packImg.height / tileSize);

  const uniqueTiles = [];
  const tileMap = {};

  for (let ty = 0; ty < baseTilesY; ty++) {
    for (let tx = 0; tx < baseTilesX; tx++) {
      const data = getTileData(baseImg, tx*tileSize, ty*tileSize, tileSize);
      if (!(data in tileMap)) {
        tileMap[data] = uniqueTiles.length;
        uniqueTiles.push(data);
      }
    }
  }

  canvas.width = baseImg.width * scale;
  canvas.height = baseImg.height * scale;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.imageSmoothingEnabled = false;

  for (let ty = 0; ty < baseTilesY; ty++) {
    for (let tx = 0; tx < baseTilesX; tx++) {
      const data = getTileData(baseImg, tx*tileSize, ty*tileSize, tileSize);
      const index = tileMap[data];
      const packIndex = index % (packTilesX * packTilesY);
      const px = (packIndex % packTilesX) * tileSize;
      const py = Math.floor(packIndex / packTilesX) * tileSize;

      ctx.drawImage(packImg, px, py, tileSize, tileSize,
        tx*tileSize*scale, ty*tileSize*scale, tileSize*scale, tileSize*scale);
    }
  }
}
</script>
</body>

</html>
